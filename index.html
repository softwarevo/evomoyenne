<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="evoMoyenne - Hub Scolaire Moderne">
    <title>evoMoyenne</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;evoMoyenne&quot;,
        &quot;short_name&quot;: &quot;evoMoyenne&quot;,
        &quot;start_url&quot;: &quot;/&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;%23121212&quot;,
        &quot;theme_color&quot;: &quot;%23121212&quot;
    }">
    
    <!-- Google Fonts & Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            /* Material 3 Light Theme */
            --md-sys-color-primary: #1a1a1a;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #e0e0e0;
            --md-sys-color-on-primary-container: #1a1a1a;
            --md-sys-color-surface: #fafafa;
            --md-sys-color-surface-dim: #f0f0f0;
            --md-sys-color-surface-bright: #ffffff;
            --md-sys-color-surface-container: #f5f5f5;
            --md-sys-color-surface-container-low: #f8f8f8;
            --md-sys-color-surface-container-high: #eeeeee;
            --md-sys-color-surface-container-highest: #e5e5e5;
            --md-sys-color-on-surface: #1a1a1a;
            --md-sys-color-on-surface-variant: #5a5a5a;
            --md-sys-color-outline: #9a9a9a;
            --md-sys-color-outline-variant: #d0d0d0;
            --md-sys-color-secondary: #4a4a4a;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #e8e8e8;
            --md-sys-color-tertiary: #6a6a6a;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-success: #2e7d32;
            --md-sys-color-shadow: rgba(0,0,0,0.15);
            
            /* Spacing & Radius */
            --radius-xl: 28px;
            --radius-lg: 20px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --radius-xs: 8px;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-medium: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 450ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --md-sys-color-primary: #e0e0e0;
            --md-sys-color-on-primary: #1a1a1a;
            --md-sys-color-primary-container: #3a3a3a;
            --md-sys-color-on-primary-container: #e0e0e0;
            --md-sys-color-surface: #121212;
            --md-sys-color-surface-dim: #0a0a0a;
            --md-sys-color-surface-bright: #1e1e1e;
            --md-sys-color-surface-container: #1a1a1a;
            --md-sys-color-surface-container-low: #161616;
            --md-sys-color-surface-container-high: #252525;
            --md-sys-color-surface-container-highest: #303030;
            --md-sys-color-on-surface: #e5e5e5;
            --md-sys-color-on-surface-variant: #a0a0a0;
            --md-sys-color-outline: #6a6a6a;
            --md-sys-color-outline-variant: #404040;
            --md-sys-color-secondary: #b0b0b0;
            --md-sys-color-on-secondary: #1a1a1a;
            --md-sys-color-secondary-container: #2a2a2a;
            --md-sys-color-tertiary: #909090;
            --md-sys-color-shadow: rgba(0,0,0,0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: background var(--transition-medium), color var(--transition-medium);
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            user-select: none;
        }

        .material-symbols-rounded.filled {
            font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 0, 'opsz' 24;
        }

        /* App Shell */
        .app-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top App Bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--md-sys-color-surface);
            z-index: 100;
            min-height: 64px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-container img {
            height: 32px;
            width: auto;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--md-sys-color-on-surface);
            transition: background var(--transition-fast);
        }

        .icon-btn:hover {
            background: var(--md-sys-color-surface-container-high);
        }

        .icon-btn:active {
            background: var(--md-sys-color-surface-container-highest);
        }

        /* Pages Container - No Slide */
        .pages-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 16px 24px;
            scroll-behavior: smooth;
        }

        .page.hidden {
            display: none;
        }

        .page::-webkit-scrollbar {
            width: 0;
        }

        /* Bottom Navigation */
        .bottom-nav {
            background: var(--md-sys-color-surface-container);
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            transition: all var(--transition-fast);
            min-width: 80px;
        }

        .nav-item.active {
            color: var(--md-sys-color-on-surface);
        }

        .nav-pill {
            position: relative;
            width: 64px;
            height: 32px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .nav-item.active .nav-pill {
            background: var(--md-sys-color-primary-container);
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        /* Cards */
        .card {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 16px;
            border: none;
        }

        .card-elevated {
            box-shadow: 0 2px 8px var(--md-sys-color-shadow);
        }

        /* Average Hero Card - Monochrome */
        .average-hero {
            text-align: center;
            padding: 32px 24px;
            background: var(--md-sys-color-surface-container);
        }

        .average-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .average-value {
            font-size: 72px;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -3px;
            color: var(--md-sys-color-on-surface);
        }

        .average-evolution {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 12px;
            padding: 6px 12px;
            background: var(--md-sys-color-surface-container-high);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface-variant);
        }

        .evolution-positive {
            color: #4caf50 !important;
        }

        .evolution-negative {
            color: #f44336 !important;
        }

        .evolution-neutral {
            color: var(--md-sys-color-on-surface-variant) !important;
        }

        /* Mode Toggle - Moved to Labo */
        .mode-toggle-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            margin-bottom: 16px;
        }

        .mode-toggle-label {
            font-size: 15px;
            font-weight: 600;
        }

        .mode-toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mode-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }

        .mode-label.active {
            color: var(--md-sys-color-on-surface);
            font-weight: 600;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 32px;
            background: var(--md-sys-color-surface-container-highest);
            border-radius: 16px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: var(--md-sys-color-primary);
            border-radius: 12px;
            transition: transform var(--transition-fast);
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        /* Coming Soon Card - Monochrome */
        .coming-soon-card {
            position: relative;
            background: var(--md-sys-color-surface-container);
            overflow: hidden;
        }

        .coming-soon-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .coming-soon-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--md-sys-color-surface-container-high);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            transition: all var(--transition-fast);
        }

        .info-btn:hover {
            background: var(--md-sys-color-surface-container-highest);
        }

        .info-btn img {
            height: 20px;
            width: auto;
        }

        .coming-soon-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .coming-soon-text {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.5;
        }

        /* Analytics Section */
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin: 16px 0;
        }

        /* Top/Flop Section */
        .topflop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .topflop-card {
            padding: 16px;
        }

        .topflop-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .topflop-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .topflop-item:not(:last-child) {
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .topflop-subject {
            font-size: 13px;
            font-weight: 500;
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .topflop-average {
            font-size: 14px;
            font-weight: 700;
        }

        /* Target Section */
        .target-card {
            background: var(--md-sys-color-surface-container);
        }

        .target-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .target-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .target-input {
            width: 60px;
            padding: 8px 12px;
            background: var(--md-sys-color-surface-container-high);
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            text-align: center;
        }

        .progress-container {
            height: 8px;
            background: var(--md-sys-color-surface-container-highest);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--md-sys-color-primary);
            border-radius: 4px;
            transition: width var(--transition-medium);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
        }

        /* LAB PAGE - Add Note Form Monochrome */
        .add-note-card {
            background: var(--md-sys-color-surface-container);
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select {
            padding: 12px 16px;
            background: var(--md-sys-color-surface-container-high);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 15px;
            color: var(--md-sys-color-on-surface);
            width: 100%;
            transition: background var(--transition-fast);
        }

        .form-input::placeholder {
            color: var(--md-sys-color-on-surface-variant);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            background: var(--md-sys-color-surface-container-highest);
        }

        .form-select option {
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
        }

        .ghost-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
        }

        .ghost-toggle-label {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--md-sys-color-on-surface);
        }

        .checkbox-m3 {
            position: relative;
            width: 20px;
            height: 20px;
            background: var(--md-sys-color-surface-container-highest);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .checkbox-m3.checked {
            background: var(--md-sys-color-primary);
        }

        .checkbox-m3 .material-symbols-rounded {
            font-size: 16px;
            color: var(--md-sys-color-on-primary);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .checkbox-m3.checked .material-symbols-rounded {
            opacity: 1;
        }

        .add-btn {
            width: 100%;
            padding: 14px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--transition-fast);
        }

        .add-btn:hover {
            opacity: 0.9;
        }

        .add-btn:active {
            transform: scale(0.98);
        }

        /* Subjects List */
        .subjects-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 24px 0 16px;
        }

        .coef-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--md-sys-color-surface-container);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .coef-btn:hover {
            background: var(--md-sys-color-surface-container-high);
        }

        .subject-card {
            margin-bottom: 12px;
        }

        .subject-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .subject-header:hover {
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--radius-xl);
        }

        .subject-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .subject-name {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subject-coef {
            font-size: 12px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }

        .subject-delete-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            transition: all var(--transition-fast);
            opacity: 0;
        }

        .subject-header:hover .subject-delete-btn {
            opacity: 1;
        }

        .subject-delete-btn:hover {
            background: rgba(186, 26, 26, 0.1);
            color: var(--md-sys-color-error);
        }

        .subject-average-pill {
            padding: 6px 14px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 20px;
            font-size: 15px;
            font-weight: 700;
        }

        .notes-list {
            padding: 0 20px 16px;
        }

        .note-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .note-item:last-child {
            border-bottom: none;
        }

        /* Ghost notes - clear visual distinction */
        .note-item.ghost {
            opacity: 0.5;
        }

        .note-item.ghost .note-value,
        .note-item.ghost .note-details {
            font-style: italic;
        }

        .note-item.ghost .note-value::after {
            content: ' üëª';
            font-style: normal;
        }

        .note-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .note-value {
            font-size: 15px;
            font-weight: 600;
        }

        .note-details {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .note-actions {
            display: flex;
            gap: 4px;
        }

        .note-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            transition: all var(--transition-fast);
        }

        .note-action-btn:hover {
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
        }

        .note-action-btn.delete:hover {
            background: rgba(186, 26, 26, 0.1);
            color: var(--md-sys-color-error);
        }

        .see-all-btn {
            width: 100%;
            padding: 12px;
            background: var(--md-sys-color-surface-container-high);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 8px;
            transition: all var(--transition-fast);
        }

        .see-all-btn:hover {
            background: var(--md-sys-color-surface-container-highest);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
        }

        .empty-state .material-symbols-rounded {
            font-size: 64px;
            color: var(--md-sys-color-outline);
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Bottom Sheet */
        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
        }

        .bottom-sheet-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--md-sys-color-surface);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            padding: 8px 24px max(24px, env(safe-area-inset-bottom));
            z-index: 1001;
            transform: translateY(100%);
            transition: transform var(--transition-medium);
            max-height: 85vh;
            overflow-y: auto;
        }

        .bottom-sheet-overlay.visible .bottom-sheet {
            transform: translateY(0);
        }

        .bottom-sheet-handle {
            width: 32px;
            height: 4px;
            background: var(--md-sys-color-outline-variant);
            border-radius: 2px;
            margin: 0 auto 20px;
        }

        .bottom-sheet-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .bottom-sheet-content {
            font-size: 15px;
            line-height: 1.6;
            color: var(--md-sys-color-on-surface-variant);
        }

        .bottom-sheet-content ul {
            margin: 16px 0;
            padding-left: 20px;
        }

        .bottom-sheet-content li {
            margin-bottom: 8px;
        }

        .bottom-sheet-close {
            width: 100%;
            padding: 16px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 24px;
            transition: all var(--transition-fast);
        }

        /* Dialog */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
        }

        .dialog-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .dialog {
            background: var(--md-sys-color-surface);
            border-radius: var(--radius-xl);
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform var(--transition-medium);
        }

        .dialog-overlay.visible .dialog {
            transform: scale(1);
        }

        .dialog-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .dialog-coef-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .dialog-coef-item:last-child {
            border-bottom: none;
        }

        .dialog-coef-name {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dialog-delete-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--md-sys-color-error);
            transition: all var(--transition-fast);
        }

        .dialog-delete-btn:hover {
            background: rgba(186, 26, 26, 0.1);
        }

        .dialog-coef-input {
            width: 60px;
            padding: 8px 12px;
            background: var(--md-sys-color-surface-container);
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            text-align: center;
        }

        .dialog-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .dialog-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .dialog-btn-secondary {
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
        }

        .dialog-btn-primary {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        /* Share Card Popup */
        .share-card-container {
            padding: 24px;
            background: var(--md-sys-color-surface-container);
            border-radius: var(--radius-xl);
            text-align: center;
        }

        .share-input-group {
            margin-bottom: 16px;
        }

        .share-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--md-sys-color-surface);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 15px;
            color: var(--md-sys-color-on-surface);
            text-align: center;
        }

        .emoji-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin: 16px 0;
        }

        .emoji-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--md-sys-color-surface);
            border-radius: var(--radius-sm);
            font-size: 22px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .emoji-btn.selected {
            background: var(--md-sys-color-primary);
            transform: scale(1.1);
        }

        /* Generated Share Card - New Design */
        .generated-card {
            width: 300px;
            margin: 0 auto;
            padding: 40px 24px;
            background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
            border-radius: var(--radius-xl);
            color: white;
            text-align: center;
        }

        .generated-card-emoji {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .generated-card-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .generated-card-label {
            font-size: 12px;
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .generated-card-average {
            font-size: 72px;
            font-weight: 800;
            line-height: 1;
            margin: 16px 0;
        }

        .generated-card-footer {
            font-size: 11px;
            opacity: 0.4;
            margin-top: 32px;
            font-style: italic;
        }

        /* Export Buttons */
        .export-section {
            margin-top: 24px;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
        }

        .export-btn {
            flex: 1;
            padding: 14px;
            background: var(--md-sys-color-surface-container);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--transition-fast);
        }

        .export-btn:hover {
            background: var(--md-sys-color-surface-container-high);
        }

        /* Snackbar */
        .snackbar {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--md-sys-color-on-surface);
            color: var(--md-sys-color-surface);
            padding: 14px 24px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: all var(--transition-medium);
            box-shadow: 0 4px 12px var(--md-sys-color-shadow);
        }

        .snackbar.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Responsive */
        @media (max-width: 380px) {
            .average-value {
                font-size: 56px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .topflop-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 768px) {
            .page {
                padding: 0 32px 32px;
            }
            
            .topflop-grid {
                gap: 16px;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }
    </style>
</head>
<body data-theme="dark">
    <div class="app-container">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="logo-container">
                <img id="logo-img" src="/assets/logos/logo-b.png" alt="Logo">
                <span class="logo-text">evoMoyenne</span>
            </div>
            <div class="top-actions">
                <button class="icon-btn" id="theme-toggle" title="Changer le th√®me">
                    <span class="material-symbols-rounded">dark_mode</span>
                </button>
                <a href="https://github.com" class="icon-btn" target="_blank" title="GitHub">
                    <img src="/assets/logos/github.png" alt="GitHub" style="width: 24px; height: 24px; filter: invert(1);" id="github-logo">
                </a>
            </div>
        </header>

        <!-- Pages -->
        <div class="pages-wrapper">
            <!-- Page Accueil -->
            <main class="page" id="page-accueil">
                <!-- Average Hero - Monochrome -->
                <div class="card average-hero" id="average-hero">
                    <div class="average-label">Moyenne G√©n√©rale</div>
                    <div class="average-value" id="average-value">--</div>
                    <div class="average-evolution" id="average-evolution">
                        <span class="material-symbols-rounded">trending_flat</span>
                        <span id="evolution-text">Pas de donn√©es</span>
                    </div>
                </div>

                <!-- Coming Soon - Updated -->
                <div class="card coming-soon-card">
                    <div class="coming-soon-header">
                        <span class="coming-soon-badge">
                            <span class="material-symbols-rounded" style="font-size: 14px;">schedule</span>
                            Prochainement
                        </span>
                        <button class="info-btn" id="info-btn">
                            <img src="/assets/logos/ed.png" alt="ED" onerror="this.style.display='none'">
                            + d'infos
                        </button>
                    </div>
                    <h3 class="coming-soon-title">Connexion EcoleDirecte</h3>
                    <p class="coming-soon-text">On travaille dur l√†-dessus !</p>
                </div>

                <!-- Chart -->
                <div class="card">
                    <h2 class="section-title">
                        <span class="material-symbols-rounded">show_chart</span>
                        √âvolution
                    </h2>
                    <div class="chart-container">
                        <canvas id="evolution-chart"></canvas>
                    </div>
                </div>

                <!-- Target -->
                <div class="card target-card">
                    <div class="target-header">
                        <h2 class="section-title" style="margin-bottom: 0;">
                            <span class="material-symbols-rounded">flag</span>
                            Objectif
                        </h2>
                        <div class="target-input-container">
                            <input type="number" class="target-input" id="target-input" min="0" max="20" step="0.1" value="20">
                            <span>/20</span>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" id="target-progress"></div>
                    </div>
                    <div class="progress-label">
                        <span id="progress-current">0.00</span>
                        <span id="progress-remaining">Il reste 14.00 pts</span>
                    </div>
                </div>

                <!-- Top/Flop -->
                <div class="topflop-grid">
                    <div class="card topflop-card">
                        <h3 class="topflop-title">
                            <span class="material-symbols-rounded" style="color: #4caf50;">trending_up</span>
                            Top 3
                        </h3>
                        <div id="top-list"></div>
                    </div>
                    <div class="card topflop-card">
                        <h3 class="topflop-title">
                            <span class="material-symbols-rounded" style="color: #f44336;">trending_down</span>
                            Flop 3
                        </h3>
                        <div id="flop-list"></div>
                    </div>
                </div>

                <!-- Export - Renamed -->
                <div class="card export-section">
                    <h2 class="section-title">
                        <span class="material-symbols-rounded">share</span>
                        Partager
                    </h2>
                    <div class="export-buttons">
                        <button class="export-btn" id="share-card-btn">
                            <span class="material-symbols-rounded">image</span>
                            Partage direct
                        </button>
                        <button class="export-btn" id="export-pdf-btn">
                            <span class="material-symbols-rounded">description</span>
                            Bulletin
                        </button>
                    </div>
                </div>
            </main>

            <!-- Page Labo -->
            <main class="page hidden" id="page-labo">
                <!-- Mode Toggle -->
                <div class="card mode-toggle-card">
                    <span class="mode-toggle-label">Mode de calcul</span>
                    <div class="mode-toggle-container">
                        <span class="mode-label active" id="mode-standard-label">Standard</span>
                        <div class="toggle-switch" id="mode-toggle"></div>
                        <span class="mode-label" id="mode-brut-label">Brut</span>
                    </div>
                </div>

                <!-- Add Note Form -->
                <div class="card add-note-card">
                    <h2 class="section-title">
                        <span class="material-symbols-rounded">add_circle</span>
                        Ajouter une note
                    </h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Mati√®re</label>
                            <select class="form-select" id="note-subject">
                                <option value="">S√©lectionner...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Note</label>
                            <input type="number" class="form-input" id="note-value" placeholder="15" min="0" max="20" step="0.01">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Sur</label>
                            <input type="number" class="form-input" id="note-max" placeholder="20" min="1" max="100" value="20">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Coef</label>
                            <input type="number" class="form-input" id="note-coef" placeholder="1" min="0.1" max="20" step="0.1" value="1">
                        </div>
                    </div>
                    <div class="ghost-toggle">
                        <div class="checkbox-m3" id="ghost-checkbox">
                            <span class="material-symbols-rounded filled">check</span>
                        </div>
                        <label class="ghost-toggle-label">
                            <span class="material-symbols-rounded">visibility_off</span>
                            Note fant√¥me (simulation)
                        </label>
                    </div>
                    <button class="add-btn" id="add-note-btn">
                        <span class="material-symbols-rounded">add</span>
                        Ajouter la note
                    </button>
                </div>

                <!-- New Subject -->
                <div class="card">
                    <h2 class="section-title">
                        <span class="material-symbols-rounded">add_box</span>
                        Nouvelle mati√®re
                    </h2>
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <input type="text" class="form-input" id="new-subject-name" placeholder="Nom de la mati√®re">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <input type="number" class="form-input" id="new-subject-coef" placeholder="Coef" min="0.1" max="20" step="0.1" value="1">
                        </div>
                    </div>
                    <button class="add-btn" id="add-subject-btn">
                        <span class="material-symbols-rounded">add</span>
                        Cr√©er la mati√®re
                    </button>
                </div>

                <!-- Subjects List -->
                <div class="subjects-header">
                    <h2 class="section-title" style="margin-bottom: 0;">
                        <span class="material-symbols-rounded">folder</span>
                        Mes mati√®res
                    </h2>
                    <button class="coef-btn" id="coef-dialog-btn">
                        <span class="material-symbols-rounded">tune</span>
                        Coefficients
                    </button>
                </div>

                <div id="subjects-container"></div>
            </main>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="accueil">
                <div class="nav-pill">
                    <span class="material-symbols-rounded filled">home</span>
                </div>
                <span class="nav-label">Accueil</span>
            </button>
            <button class="nav-item" data-page="labo">
                <div class="nav-pill">
                    <span class="material-symbols-rounded">science</span>
                </div>
                <span class="nav-label">Labo</span>
            </button>
        </nav>
    </div>

    <!-- Bottom Sheet (Info EcoleDirecte) -->
    <div class="bottom-sheet-overlay" id="info-sheet">
        <div class="bottom-sheet">
            <div class="bottom-sheet-handle"></div>
            <h2 class="bottom-sheet-title">Connexion √† EcoleDirecte</h2>
            <div class="bottom-sheet-content">
                <p>Bient√¥t disponible ! La connexion √† EcoleDirecte te permettra de :</p>
                <ul>
                    <li>üìö Synchroniser automatiquement tes notes</li>
                    <li>üìÖ Voir tes devoirs et contr√¥les √† venir</li>
                    <li>‚è∞ Consulter ton emploi du temps</li>
                </ul>
                <p>On travaille dur pour te proposer cette fonctionnalit√© le plus vite possible !</p>
            </div>
            <button class="bottom-sheet-close" id="close-info-sheet">J'ai compris</button>
        </div>
    </div>

    <!-- Coefficients Dialog -->
    <div class="dialog-overlay" id="coef-dialog">
        <div class="dialog">
            <h2 class="dialog-title">Coefficients des mati√®res</h2>
            <div id="coef-list"></div>
            <div class="dialog-actions">
                <button class="dialog-btn dialog-btn-secondary" id="close-coef-dialog">Annuler</button>
                <button class="dialog-btn dialog-btn-primary" id="save-coef-dialog">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Share Card Dialog -->
    <div class="dialog-overlay" id="share-dialog">
        <div class="dialog" style="max-width: 360px;">
            <h2 class="dialog-title">Cr√©er ta carte de partage</h2>
            <div class="share-card-container" id="share-form">
                <div class="share-input-group">
                    <input type="text" class="share-input" id="share-name" placeholder="Ton pr√©nom" maxlength="20">
                </div>
                <p style="font-size: 13px; color: var(--md-sys-color-on-surface-variant); margin-bottom: 8px;">Choisis un emoji</p>
                <div class="emoji-picker" id="emoji-picker"></div>
            </div>
            <div id="share-preview" style="display: none;"></div>
            <div class="dialog-actions">
                <button class="dialog-btn dialog-btn-secondary" id="close-share-dialog">Fermer</button>
                <button class="dialog-btn dialog-btn-primary" id="generate-share-card">G√©n√©rer</button>
            </div>
        </div>
    </div>

    <!-- Edit Note Dialog -->
    <div class="dialog-overlay" id="edit-dialog">
        <div class="dialog">
            <h2 class="dialog-title">Modifier la note</h2>
            <div class="form-row" style="flex-direction: column; gap: 16px;">
                <div class="form-group">
                    <label class="form-label">Note</label>
                    <input type="number" class="form-input" id="edit-note-value" min="0" max="20" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Sur</label>
                    <input type="number" class="form-input" id="edit-note-max" min="1" max="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Coefficient</label>
                    <input type="number" class="form-input" id="edit-note-coef" min="0.1" max="20" step="0.1">
                </div>
                <div class="ghost-toggle" style="padding: 0;">
                    <div class="checkbox-m3" id="edit-ghost-checkbox">
                        <span class="material-symbols-rounded filled">check</span>
                    </div>
                    <label class="ghost-toggle-label">Note fant√¥me (simulation)</label>
                </div>
            </div>
            <div class="dialog-actions">
                <button class="dialog-btn dialog-btn-secondary" id="close-edit-dialog">Annuler</button>
                <button class="dialog-btn dialog-btn-primary" id="save-edit-dialog">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Snackbar -->
    <div class="snackbar" id="snackbar"></div>

    <script>
        // ==================== DATA MANAGEMENT ====================
        const defaultSubjects = [
            { id: 'maths', name: 'Math√©matiques', coef: 3, notes: [], isDefault: true },
            { id: 'francais', name: 'Fran√ßais', coef: 3, notes: [], isDefault: true },
            { id: 'histoire', name: 'Histoire-G√©o', coef: 2, notes: [], isDefault: true },
            { id: 'anglais', name: 'Anglais', coef: 2, notes: [], isDefault: true },
            { id: 'physique', name: 'Physique-Chimie', coef: 1, notes: [], isDefault: true },
            { id: 'svt', name: 'SVT', coef: 1, notes: [], isDefault: true },
            { id: 'eps', name: 'EPS', coef: 1, notes: [], isDefault: true },
        ];

        let data = {
            subjects: [],
            history: {},
            target: 14,
            mode: 'standard',
            theme: 'dark'
        };

        function loadData() {
            const saved = localStorage.getItem('evoMoyenne');
            if (saved) {
                data = { ...data, ...JSON.parse(saved) };
            } else {
                data.subjects = JSON.parse(JSON.stringify(defaultSubjects));
            }
            applyTheme(data.theme);
        }

        function saveData() {
            localStorage.setItem('evoMoyenne', JSON.stringify(data));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ==================== CALCULATIONS ====================
        function calculateSubjectAverage(subject, includeGhost = true) {
            const notes = includeGhost ? subject.notes : subject.notes.filter(n => !n.ghost);
            if (notes.length === 0) return null;
            
            let totalWeighted = 0;
            let totalCoef = 0;
            
            notes.forEach(note => {
                const normalized = (note.value / note.max) * 20;
                totalWeighted += normalized * note.coef;
                totalCoef += note.coef;
            });
            
            return totalCoef > 0 ? totalWeighted / totalCoef : null;
        }

        function calculateGeneralAverage() {
    let totalWeightedMoyennes = 0;
    let totalWeights = 0;

    Object.keys(data.subjects).forEach(subjectName => {
        const subject = data.subjects[subjectName];
        const notes = subject.notes || [];
        
        if (notes.length > 0) {
            // 1. Calcul de la moyenne de la mati√®re
            const sum = notes.reduce((a, b) => a + b.value, 0);
            const subjectMoyenne = sum / notes.length;
            
            // 2. TON NOUVEAU CALCUL : (Coef Mati√®re) * (Nombre de notes)
            // On s'assure d'avoir au moins 1 si le coef est mal lu
            const coefMatiere = subject.coef || 1;
            const weight = coefMatiere * notes.length;
            
            totalWeightedMoyennes += (subjectMoyenne * weight);
            totalWeights += weight;
        }
    });

    return totalWeights > 0 ? (totalWeightedMoyennes / totalWeights).toFixed(2) : "0.00";
}
            });
            
            return totalCoef > 0 ? totalWeighted / totalCoef : null;
        }

        function getTopFlop() {
            const subjectsWithAvg = data.subjects
                .map(s => ({ name: s.name, avg: calculateSubjectAverage(s) }))
                .filter(s => s.avg !== null)
                .sort((a, b) => b.avg - a.avg);
            
            return {
                top: subjectsWithAvg.slice(0, 3),
                flop: subjectsWithAvg.slice(-3).reverse()
            };
        }

        function getTodayKey() {
            return new Date().toISOString().split('T')[0];
        }

        function saveHistory() {
            const today = getTodayKey();
            const generale = calculateGeneralAverage('standard');
            const brute = calculateGeneralAverage('brut');
            
            if (generale !== null) {
                data.history[today] = { generale, brute };
                saveData();
            }
        }

        function getEvolution() {
            const keys = Object.keys(data.history).sort();
            if (keys.length < 2) return null;
            
            const today = keys[keys.length - 1];
            const yesterday = keys[keys.length - 2];
            
            const current = data.history[today]?.generale;
            const previous = data.history[yesterday]?.generale;
            
            if (current && previous) {
                return current - previous;
            }
            return null;
        }

        // ==================== UI UPDATES ====================
        function updateAverageDisplay() {
            const avg = calculateGeneralAverage(data.mode);
            const avgEl = document.getElementById('average-value');
            const evolutionEl = document.getElementById('average-evolution');
            const evolutionText = document.getElementById('evolution-text');
            
            if (avg !== null) {
                const oldAvg = parseFloat(avgEl.textContent) || 0;
                avgEl.textContent = avg.toFixed(2);
                
                if (oldAvg > 0 && avg > oldAvg) {
                    triggerConfetti();
                }
            } else {
                avgEl.textContent = '--';
            }
            
            const evolution = getEvolution();
            if (evolution !== null) {
                const sign = evolution >= 0 ? '+' : '';
                evolutionText.textContent = `${sign}${evolution.toFixed(2)} vs hier`;
                evolutionEl.className = 'average-evolution';
                const icon = evolutionEl.querySelector('.material-symbols-rounded');
                
                if (evolution > 0) {
                    icon.textContent = 'trending_up';
                    evolutionText.classList.add('evolution-positive');
                    evolutionText.classList.remove('evolution-negative', 'evolution-neutral');
                } else if (evolution < 0) {
                    icon.textContent = 'trending_down';
                    evolutionText.classList.add('evolution-negative');
                    evolutionText.classList.remove('evolution-positive', 'evolution-neutral');
                } else {
                    icon.textContent = 'trending_flat';
                    evolutionText.classList.add('evolution-neutral');
                    evolutionText.classList.remove('evolution-positive', 'evolution-negative');
                }
            }
            
            updateTargetProgress();
            saveHistory();
        }

        function updateTargetProgress() {
            const avg = calculateGeneralAverage(data.mode);
            const target = parseFloat(document.getElementById('target-input').value) || 14;
            
            const progressBar = document.getElementById('target-progress');
            const progressCurrent = document.getElementById('progress-current');
            const progressRemaining = document.getElementById('progress-remaining');
            
            if (avg !== null) {
                const percentage = Math.min(100, (avg / target) * 100);
                progressBar.style.width = percentage + '%';
                progressCurrent.textContent = avg.toFixed(2);
                
                const remaining = Math.max(0, target - avg);
                if (remaining > 0) {
                    progressRemaining.textContent = `Il reste ${remaining.toFixed(2)} pts`;
                } else {
                    progressRemaining.textContent = 'üéâ Objectif atteint !';
                }
            } else {
                progressBar.style.width = '0%';
                progressCurrent.textContent = '0.00';
                progressRemaining.textContent = `Il reste ${target.toFixed(2)} pts`;
            }
        }

        function updateTopFlop() {
            const { top, flop } = getTopFlop();
            
            const topList = document.getElementById('top-list');
            const flopList = document.getElementById('flop-list');
            
            topList.innerHTML = top.map(s => `
                <div class="topflop-item">
                    <span class="topflop-subject">${s.name}</span>
                    <span class="topflop-average" style="color: #4caf50;">${s.avg.toFixed(2)}</span>
                </div>
            `).join('') || '<p style="font-size: 13px; color: var(--md-sys-color-on-surface-variant);">Aucune note</p>';
            
            flopList.innerHTML = flop.map(s => `
                <div class="topflop-item">
                    <span class="topflop-subject">${s.name}</span>
                    <span class="topflop-average" style="color: #f44336;">${s.avg.toFixed(2)}</span>
                </div>
            `).join('') || '<p style="font-size: 13px; color: var(--md-sys-color-on-surface-variant);">Aucune note</p>';
        }

        function updateSubjectSelect() {
            const select = document.getElementById('note-subject');
            select.innerHTML = '<option value="">S√©lectionner...</option>' +
                data.subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        function updateSubjectsList() {
            const container = document.getElementById('subjects-container');
            
            if (data.subjects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-symbols-rounded">folder_off</span>
                        <h3>Aucune mati√®re</h3>
                        <p>Ajoute ta premi√®re mati√®re pour commencer</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = data.subjects.map(subject => {
                const avg = calculateSubjectAverage(subject);
                const recentNotes = subject.notes.slice(-3).reverse();
                const hasMore = subject.notes.length > 3;
                
                return `
                    <div class="card subject-card" data-subject="${subject.id}">
                        <div class="subject-header">
                            <div class="subject-info" onclick="toggleSubject('${subject.id}')">
                                <div class="subject-name">
                                    ${subject.name}
                                    <span class="subject-coef">√ó${subject.coef}</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${!subject.isDefault ? `
                                    <button class="subject-delete-btn" onclick="deleteSubject('${subject.id}')" title="Supprimer">
                                        <span class="material-symbols-rounded" style="font-size: 18px;">close</span>
                                    </button>
                                ` : ''}
                                <div class="subject-average-pill" onclick="toggleSubject('${subject.id}')">${avg !== null ? avg.toFixed(2) : '--'}</div>
                            </div>
                        </div>
                        <div class="notes-list" id="notes-${subject.id}" style="display: none;">
                            ${subject.notes.length === 0 ? 
                                '<p style="text-align: center; color: var(--md-sys-color-on-surface-variant); font-size: 13px; padding: 16px 0;">Aucune note</p>' :
                                recentNotes.map(note => renderNote(subject.id, note)).join('')
                            }
                            ${hasMore ? `
                                <button class="see-all-btn" onclick="showAllNotes('${subject.id}')">
                                    <span class="material-symbols-rounded">expand_more</span>
                                    Voir tout (${subject.notes.length} notes)
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderNote(subjectId, note) {
            return `
                <div class="note-item ${note.ghost ? 'ghost' : ''}" data-note="${note.id}">
                    <div class="note-info">
                        <span class="note-value">${note.value}/${note.max}</span>
                        <span class="note-details">Coef ${note.coef} ‚Ä¢ ${new Date(note.date).toLocaleDateString('fr-FR')}</span>
                    </div>
                    <div class="note-actions">
                        <button class="note-action-btn" onclick="toggleNoteGhost('${subjectId}', '${note.id}')" title="${note.ghost ? 'Rendre r√©elle' : 'Rendre fant√¥me'}">
                            <span class="material-symbols-rounded">${note.ghost ? 'visibility' : 'visibility_off'}</span>
                        </button>
                        <button class="note-action-btn" onclick="editNote('${subjectId}', '${note.id}')" title="Modifier">
                            <span class="material-symbols-rounded">edit</span>
                        </button>
                        <button class="note-action-btn delete" onclick="deleteNote('${subjectId}', '${note.id}')" title="Supprimer">
                            <span class="material-symbols-rounded">delete</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function toggleSubject(subjectId) {
            const notesList = document.getElementById(`notes-${subjectId}`);
            notesList.style.display = notesList.style.display === 'none' ? 'block' : 'none';
            hapticFeedback();
        }

        function showAllNotes(subjectId) {
            const subject = data.subjects.find(s => s.id === subjectId);
            if (!subject) return;
            
            const notesList = document.getElementById(`notes-${subjectId}`);
            notesList.innerHTML = subject.notes.slice().reverse().map(note => renderNote(subjectId, note)).join('');
        }

        // ==================== CHART ====================
        let evolutionChart = null;

        function initChart() {
            const ctx = document.getElementById('evolution-chart').getContext('2d');
            
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Moyenne',
                        data: [],
                        borderColor: getComputedStyle(document.body).getPropertyValue('--md-sys-color-primary').trim(),
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: getComputedStyle(document.body).getPropertyValue('--md-sys-color-on-surface-variant').trim(),
                                font: { family: 'Inter' }
                            }
                        },
                        y: {
                            min: 0,
                            max: 20,
                            grid: { 
                                color: getComputedStyle(document.body).getPropertyValue('--md-sys-color-outline-variant').trim()
                            },
                            ticks: { 
                                color: getComputedStyle(document.body).getPropertyValue('--md-sys-color-on-surface-variant').trim(),
                                font: { family: 'Inter' }
                            }
                        }
                    }
                }
            });
            
            updateChart();
        }

        function updateChart() {
            if (!evolutionChart) return;
            
            const keys = Object.keys(data.history).sort().slice(-14);
            const isStandard = data.mode === 'standard';
            
            evolutionChart.data.labels = keys.map(k => {
                const date = new Date(k);
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            });
            
            evolutionChart.data.datasets[0].data = keys.map(k => {
                return isStandard ? data.history[k].generale : data.history[k].brute;
            });
            
            const primaryColor = getComputedStyle(document.body).getPropertyValue('--md-sys-color-primary').trim();
            evolutionChart.data.datasets[0].borderColor = primaryColor;
            
            evolutionChart.update();
        }

        // ==================== ACTIONS ====================
        function addNote() {
            const subjectId = document.getElementById('note-subject').value;
            const value = parseFloat(document.getElementById('note-value').value);
            const max = parseFloat(document.getElementById('note-max').value) || 20;
            const coef = parseFloat(document.getElementById('note-coef').value) || 1;
            const isGhost = document.getElementById('ghost-checkbox').classList.contains('checked');
            
            if (!subjectId || isNaN(value)) {
                showSnackbar('Remplis tous les champs obligatoires');
                return;
            }
            
            if (value < 0 || value > max) {
                showSnackbar('Note invalide');
                return;
            }
            
            const subject = data.subjects.find(s => s.id === subjectId);
            if (!subject) return;
            
            subject.notes.push({
                id: generateId(),
                value,
                max,
                coef,
                ghost: isGhost,
                date: new Date().toISOString()
            });
            
            saveData();
            updateAll();
            
            document.getElementById('note-value').value = '';
            document.getElementById('note-max').value = '20';
            document.getElementById('note-coef').value = '1';
            document.getElementById('ghost-checkbox').classList.remove('checked');
            
            hapticFeedback();
            showSnackbar('Note ajout√©e !');
        }

        function addSubject() {
            const name = document.getElementById('new-subject-name').value.trim();
            const coef = parseFloat(document.getElementById('new-subject-coef').value) || 1;
            
            if (!name) {
                showSnackbar('Entre un nom de mati√®re');
                return;
            }
            
            const id = name.toLowerCase().replace(/\s+/g, '-') + '-' + generateId();
            
            data.subjects.push({
                id,
                name,
                coef,
                notes: [],
                isDefault: false
            });
            
            saveData();
            updateAll();
            
            document.getElementById('new-subject-name').value = '';
            document.getElementById('new-subject-coef').value = '1';
            
            hapticFeedback();
            showSnackbar('Mati√®re cr√©√©e !');
        }

        function deleteSubject(subjectId) {
            const subject = data.subjects.find(s => s.id === subjectId);
            if (!subject || subject.isDefault) return;
            
            if (confirm(`Supprimer la mati√®re "${subject.name}" et toutes ses notes ?`)) {
                data.subjects = data.subjects.filter(s => s.id !== subjectId);
                saveData();
                updateAll();
                hapticFeedback();
                showSnackbar('Mati√®re supprim√©e');
            }
        }

        function deleteNote(subjectId, noteId) {
            const subject = data.subjects.find(s => s.id === subjectId);
            if (!subject) return;
            
            subject.notes = subject.notes.filter(n => n.id !== noteId);
            saveData();
            updateAll();
            hapticFeedback();
            showSnackbar('Note supprim√©e');
        }

        function toggleNoteGhost(subjectId, noteId) {
            const subject = data.subjects.find(s => s.id === subjectId);
            if (!subject) return;
            
            const note = subject.notes.find(n => n.id === noteId);
            if (!note) return;
            
            note.ghost = !note.ghost;
            saveData();
            updateAll();
            hapticFeedback();
        }

        let editingNote = null;

        function editNote(subjectId, noteId) {
            const subject = data.subjects.find(s => s.id === subjectId);
            if (!subject) return;
            
            const note = subject.notes.find(n => n.id === noteId);
            if (!note) return;
            
            editingNote = { subjectId, noteId };
            
            document.getElementById('edit-note-value').value = note.value;
            document.getElementById('edit-note-max').value = note.max;
            document.getElementById('edit-note-coef').value = note.coef;
            
            const editGhostCheckbox = document.getElementById('edit-ghost-checkbox');
            if (note.ghost) {
                editGhostCheckbox.classList.add('checked');
            } else {
                editGhostCheckbox.classList.remove('checked');
            }
            
            document.getElementById('edit-dialog').classList.add('visible');
        }

        function saveEdit() {
            if (!editingNote) return;
            
            const subject = data.subjects.find(s => s.id === editingNote.subjectId);
            if (!subject) return;
            
            const note = subject.notes.find(n => n.id === editingNote.noteId);
            if (!note) return;
            
            note.value = parseFloat(document.getElementById('edit-note-value').value);
            note.max = parseFloat(document.getElementById('edit-note-max').value);
            note.coef = parseFloat(document.getElementById('edit-note-coef').value);
            note.ghost = document.getElementById('edit-ghost-checkbox').classList.contains('checked');
            
            saveData();
            updateAll();
            
            document.getElementById('edit-dialog').classList.remove('visible');
            editingNote = null;
            hapticFeedback();
            showSnackbar('Note modifi√©e');
        }

        // ==================== DIALOGS ====================
        function openCoefDialog() {
            const list = document.getElementById('coef-list');
            list.innerHTML = data.subjects.map(s => `
                <div class="dialog-coef-item">
                    <div class="dialog-coef-name">
                        ${!s.isDefault ? `
                            <button class="dialog-delete-btn" onclick="deleteSubjectFromDialog('${s.id}')" title="Supprimer">
                                <span class="material-symbols-rounded" style="font-size: 16px;">delete</span>
                            </button>
                        ` : ''}
                        <span>${s.name}</span>
                    </div>
                    <input type="number" class="dialog-coef-input" data-subject="${s.id}" value="${s.coef}" min="0.1" max="20" step="0.1">
                </div>
            `).join('');
            
            document.getElementById('coef-dialog').classList.add('visible');
        }

        function deleteSubjectFromDialog(subjectId) {
            const subject = data.subjects.find(s => s.id === subjectId);
            if (!subject || subject.isDefault) return;
            
            if (confirm(`Supprimer la mati√®re "${subject.name}" et toutes ses notes ?`)) {
                data.subjects = data.subjects.filter(s => s.id !== subjectId);
                saveData();
                updateAll();
                openCoefDialog();
                hapticFeedback();
                showSnackbar('Mati√®re supprim√©e');
            }
        }

        function saveCoefs() {
            const inputs = document.querySelectorAll('.dialog-coef-input');
            inputs.forEach(input => {
                const subject = data.subjects.find(s => s.id === input.dataset.subject);
                if (subject) {
                    subject.coef = parseFloat(input.value) || 1;
                }
            });
            
            saveData();
            updateAll();
            document.getElementById('coef-dialog').classList.remove('visible');
            hapticFeedback();
            showSnackbar('Coefficients sauvegard√©s');
        }

        // ==================== SHARE & EXPORT ====================
        // Extended emoji list with negative/neutral states
        const emojis = ['üìà', 'üòé', 'üéØ', 'üèÜ', '‚≠ê', 'üöÄ', 'üí™', 'üî•', '‚ú®', 'üéì', 'ü§î', 'üìâ', 'üíÄ', 'ü´†', 'üòÖ', 'üôÉ'];
        let selectedEmoji = 'üìà';

        function initShareDialog() {
            const picker = document.getElementById('emoji-picker');
            picker.innerHTML = emojis.map(e => `
                <button class="emoji-btn ${e === selectedEmoji ? 'selected' : ''}" data-emoji="${e}">${e}</button>
            `).join('');
            
            picker.addEventListener('click', (e) => {
                if (e.target.classList.contains('emoji-btn')) {
                    picker.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                    selectedEmoji = e.target.dataset.emoji;
                    hapticFeedback();
                }
            });
        }

        async function generateShareCard() {
            const name = document.getElementById('share-name').value.trim() || '√âl√®ve';
            const avg = calculateGeneralAverage(data.mode);
            
            if (avg === null) {
                showSnackbar('Ajoute des notes d\'abord');
                return;
            }
            
            // New card design without header title
            const preview = document.getElementById('share-preview');
            preview.innerHTML = `
                <div class="generated-card" id="generated-card">
                    <div class="generated-card-emoji">${selectedEmoji}</div>
                    <div class="generated-card-name">${name}</div>
                    <div class="generated-card-label">Moyenne G√©n√©rale</div>
                    <div class="generated-card-average">${avg.toFixed(2)}</div>
                    <div class="generated-card-footer">calcul√© avec evoMoyenne</div>
                </div>
            `;
            
            document.getElementById('share-form').style.display = 'none';
            preview.style.display = 'block';
            
            setTimeout(async () => {
                try {
                    const canvas = await html2canvas(document.getElementById('generated-card'), {
                        scale: 2,
                        backgroundColor: null
                    });
                    
                    const link = document.createElement('a');
                    link.download = `evomoyenne-${name.toLowerCase()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    
                    showSnackbar('Image t√©l√©charg√©e !');
                } catch (err) {
                    showSnackbar('Erreur lors de la g√©n√©ration');
                }
            }, 100);
        }

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const avg = calculateGeneralAverage(data.mode);
            const date = new Date().toLocaleDateString('fr-FR');
            
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('Bulletin de notes', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`G√©n√©r√© le ${date}`, 105, 28, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Moyenne G√©n√©rale', 20, 50);
            
            doc.setFontSize(32);
            doc.text(avg !== null ? avg.toFixed(2) + '/20' : '--', 20, 65);
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('D√©tail par mati√®re', 20, 90);
            
            let y = 100;
            doc.setFontSize(11);
            
            data.subjects.forEach(subject => {
                const subjectAvg = calculateSubjectAverage(subject);
                doc.setFont(undefined, 'bold');
                doc.text(subject.name, 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(`Coef ${subject.coef} - Moyenne: ${subjectAvg !== null ? subjectAvg.toFixed(2) : '--'}`, 20, y + 6);
                
                if (subject.notes.length > 0) {
                    const notesText = subject.notes.map(n => `${n.value}/${n.max}${n.ghost ? ' (sim)' : ''}`).join(', ');
                    doc.setFontSize(9);
                    doc.text(`Notes: ${notesText}`, 25, y + 11);
                    doc.setFontSize(11);
                    y += 20;
                } else {
                    y += 14;
                }
                
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
            });
            
            doc.setFontSize(9);
            doc.text('G√©n√©r√© avec evoMoyenne', 105, 285, { align: 'center' });
            
            doc.save('bulletin-evomoyenne.pdf');
            showSnackbar('Bulletin t√©l√©charg√© !');
        }

        // ==================== NAVIGATION - No Slide ====================
        let currentPage = 'accueil';

        function switchPage(pageName) {
            currentPage = pageName;
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show selected page
            document.getElementById(`page-${pageName}`).classList.remove('hidden');
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                const icon = item.querySelector('.material-symbols-rounded');
                if (item.dataset.page === pageName) {
                    item.classList.add('active');
                    icon.classList.add('filled');
                } else {
                    item.classList.remove('active');
                    icon.classList.remove('filled');
                }
            });
            
            hapticFeedback();
        }

        // ==================== THEME ====================
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            data.theme = theme;
            
            const themeToggle = document.getElementById('theme-toggle');
            const icon = themeToggle.querySelector('.material-symbols-rounded');
            icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
            
            const logo = document.getElementById('logo-img');
            logo.src = theme === 'dark' ? '/assets/logos/logo-b.png' : '/assets/logos/logo-n.png';
            
            const githubLogo = document.getElementById('github-logo');
            githubLogo.style.filter = theme === 'dark' ? 'invert(1)' : 'invert(0)';
            
            if (evolutionChart) {
                setTimeout(updateChart, 100);
            }
            
            saveData();
        }

        function toggleTheme() {
            const newTheme = data.theme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            hapticFeedback();
        }

        // ==================== UTILS ====================
        function hapticFeedback() {
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        function triggerConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#666666', '#888888', '#aaaaaa', '#cccccc', '#ffffff']
            });
        }

        function showSnackbar(message) {
            const snackbar = document.getElementById('snackbar');
            snackbar.textContent = message;
            snackbar.classList.add('visible');
            
            setTimeout(() => {
                snackbar.classList.remove('visible');
            }, 3000);
        }

        function updateAll() {
            updateAverageDisplay();
            updateTopFlop();
            updateSubjectSelect();
            updateSubjectsList();
            updateChart();
        }

        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Navigation - instant switch
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => switchPage(item.dataset.page));
            });
            
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // Mode toggle
            document.getElementById('mode-toggle').addEventListener('click', () => {
                const toggle = document.getElementById('mode-toggle');
                toggle.classList.toggle('active');
                data.mode = toggle.classList.contains('active') ? 'brut' : 'standard';
                
                document.getElementById('mode-standard-label').classList.toggle('active', data.mode === 'standard');
                document.getElementById('mode-brut-label').classList.toggle('active', data.mode === 'brut');
                
                saveData();
                updateAverageDisplay();
                updateChart();
                hapticFeedback();
            });
            
            // Add note
            document.getElementById('add-note-btn').addEventListener('click', addNote);
            
            // Add subject
            document.getElementById('add-subject-btn').addEventListener('click', addSubject);
            
            // Ghost checkbox
            document.getElementById('ghost-checkbox').addEventListener('click', function() {
                this.classList.toggle('checked');
                hapticFeedback();
            });
            
            // Edit ghost checkbox
            document.getElementById('edit-ghost-checkbox').addEventListener('click', function() {
                this.classList.toggle('checked');
                hapticFeedback();
            });
            
            // Target input
            document.getElementById('target-input').addEventListener('change', function() {
                data.target = parseFloat(this.value) || 14;
                saveData();
                updateTargetProgress();
            });
            
            // Info sheet
            document.getElementById('info-btn').addEventListener('click', () => {
                document.getElementById('info-sheet').classList.add('visible');
            });
            
            document.getElementById('close-info-sheet').addEventListener('click', () => {
                document.getElementById('info-sheet').classList.remove('visible');
            });
            
            document.getElementById('info-sheet').addEventListener('click', (e) => {
                if (e.target.id === 'info-sheet') {
                    document.getElementById('info-sheet').classList.remove('visible');
                }
            });
            
            // Coef dialog
            document.getElementById('coef-dialog-btn').addEventListener('click', openCoefDialog);
            
            document.getElementById('close-coef-dialog').addEventListener('click', () => {
                document.getElementById('coef-dialog').classList.remove('visible');
            });
            
            document.getElementById('save-coef-dialog').addEventListener('click', saveCoefs);
            
            document.getElementById('coef-dialog').addEventListener('click', (e) => {
                if (e.target.id === 'coef-dialog') {
                    document.getElementById('coef-dialog').classList.remove('visible');
                }
            });
            
            // Edit dialog
            document.getElementById('close-edit-dialog').addEventListener('click', () => {
                document.getElementById('edit-dialog').classList.remove('visible');
                editingNote = null;
            });
            
            document.getElementById('save-edit-dialog').addEventListener('click', saveEdit);
            
            document.getElementById('edit-dialog').addEventListener('click', (e) => {
                if (e.target.id === 'edit-dialog') {
                    document.getElementById('edit-dialog').classList.remove('visible');
                    editingNote = null;
                }
            });
            
            // Share dialog
            document.getElementById('share-card-btn').addEventListener('click', () => {
                document.getElementById('share-form').style.display = 'block';
                document.getElementById('share-preview').style.display = 'none';
                document.getElementById('share-dialog').classList.add('visible');
            });
            
            document.getElementById('close-share-dialog').addEventListener('click', () => {
                document.getElementById('share-dialog').classList.remove('visible');
            });
            
            document.getElementById('generate-share-card').addEventListener('click', generateShareCard);
            
            document.getElementById('share-dialog').addEventListener('click', (e) => {
                if (e.target.id === 'share-dialog') {
                    document.getElementById('share-dialog').classList.remove('visible');
                }
            });
            
            // PDF export
            document.getElementById('export-pdf-btn').addEventListener('click', exportPDF);
        }

        // ==================== PWA SERVICE WORKER ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'evomoyenne';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl).catch(() => {});
            });
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initEventListeners();
            initShareDialog();
            initChart();
            updateAll();
            
            // Set initial mode toggle state
            if (data.mode === 'brut') {
                document.getElementById('mode-toggle').classList.add('active');
                document.getElementById('mode-brut-label').classList.add('active');
                document.getElementById('mode-standard-label').classList.remove('active');
            } else {
                document.getElementById('mode-standard-label').classList.add('active');
            }
        });
    </script>
</body>
</html>
